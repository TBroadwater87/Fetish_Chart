<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fetish Chart 2025 - Couples Edition</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 30px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 3px solid #667eea;
        }
        
        .header h1 {
            color: #2d3748;
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .header p {
            color: #718096;
            font-size: 0.95em;
            line-height: 1.6;
        }
        
        .mode-select {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .mode-card {
            background: #f7fafc;
            border: 3px solid #e2e8f0;
            border-radius: 15px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .mode-card:hover {
            border-color: #667eea;
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.2);
        }
        
        .mode-card.active {
            border-color: #667eea;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .mode-card h3 {
            font-size: 1.8em;
            margin-bottom: 10px;
        }
        
        .mode-card p {
            font-size: 0.95em;
            opacity: 0.9;
        }
        
        .hidden {
            display: none !important;
        }
        
        .key {
            background: #f7fafc;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 30px;
            border: 2px solid #e2e8f0;
        }
        
        .key h3 {
            color: #2d3748;
            margin-bottom: 15px;
            font-size: 1.2em;
        }
        
        .key-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
        }
        
        .key-item {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.9em;
        }
        
        .key-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
            flex-shrink: 0;
        }
        
        .info-section {
            background: #f7fafc;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 30px;
            border: 2px solid #e2e8f0;
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .info-field {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .info-field label {
            font-weight: 600;
            color: #4a5568;
            font-size: 0.9em;
        }
        
        .info-field input {
            padding: 10px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1em;
            transition: all 0.3s;
        }
        
        .info-field input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .section {
            margin-bottom: 35px;
        }
        
        .section-title {
            color: #2d3748;
            font-size: 1.8em;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .section-icon {
            font-size: 1.2em;
        }
        
        .items-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 15px;
        }
        
        .item {
            background: #f7fafc;
            border-radius: 10px;
            padding: 15px;
            border: 2px solid #e2e8f0;
            transition: all 0.3s;
        }
        
        .item:hover {
            border-color: #667eea;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
        }
        
        .item-name {
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 10px;
            font-size: 1em;
        }
        
        .item-options {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .option-btn {
            flex: 1;
            min-width: 45px;
            padding: 8px 5px;
            border: 2px solid transparent;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85em;
            font-weight: 600;
            text-align: center;
            transition: all 0.3s;
            background: white;
            color: #4a5568;
        }
        
        .option-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .option-btn.selected {
            border-width: 3px;
            transform: scale(1.05);
        }
        
        .option-btn.favorite { border-color: #48bb78; }
        .option-btn.favorite.selected { background: #48bb78; color: white; }
        
        .option-btn.yes { border-color: #81e6d9; }
        .option-btn.yes.selected { background: #81e6d9; color: #234e52; }
        
        .option-btn.maybe { border-color: #f6e05e; }
        .option-btn.maybe.selected { background: #f6e05e; color: #744210; }
        
        .option-btn.no { border-color: #fc8181; }
        .option-btn.no.selected { background: #fc8181; color: white; }
        
        .option-btn.limit { border-color: #f56565; }
        .option-btn.limit.selected { background: #f56565; color: white; }
        
        .action-buttons {
            position: sticky;
            bottom: 20px;
            display: flex;
            gap: 15px;
            margin-top: 30px;
            padding: 20px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.1);
        }
        
        .btn {
            flex: 1;
            padding: 15px 25px;
            border: none;
            border-radius: 10px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-secondary {
            background: #48bb78;
            color: white;
        }
        
        .btn-tertiary {
            background: #4299e1;
            color: white;
        }
        
        .btn-danger {
            background: #f56565;
            color: white;
        }
        
        .progress-bar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: #e2e8f0;
            z-index: 1000;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #48bb78, #667eea);
            transition: width 0.3s;
            width: 0%;
        }
        
        .stats {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            text-align: center;
        }
        
        .stat-item h4 {
            font-size: 2em;
            margin-bottom: 5px;
        }
        
        .stat-item p {
            font-size: 0.9em;
            opacity: 0.9;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 600px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-content h2 {
            margin-bottom: 20px;
            color: #2d3748;
        }
        
        .modal-content textarea {
            width: 100%;
            min-height: 150px;
            padding: 15px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-family: monospace;
            font-size: 0.85em;
            resize: vertical;
        }
        
        .modal-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .comparison-grid {
            display: grid;
            gap: 20px;
        }
        
        .comparison-item {
            background: #f7fafc;
            border-radius: 12px;
            padding: 20px;
            border: 2px solid #e2e8f0;
        }
        
        .comparison-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e2e8f0;
        }
        
        .comparison-header h3 {
            color: #2d3748;
            font-size: 1.2em;
        }
        
        .match-badge {
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.85em;
        }
        
        .match-badge.perfect {
            background: #48bb78;
            color: white;
        }
        
        .match-badge.close {
            background: #81e6d9;
            color: #234e52;
        }
        
        .match-badge.mismatch {
            background: #fc8181;
            color: white;
        }
        
        .match-badge.partial {
            background: #f6e05e;
            color: #744210;
        }
        
        .response-comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        .person-response {
            padding: 15px;
            background: white;
            border-radius: 8px;
            border: 2px solid #e2e8f0;
        }
        
        .person-label {
            font-weight: 600;
            color: #4a5568;
            margin-bottom: 10px;
            font-size: 0.9em;
        }
        
        .response-value {
            display: inline-block;
            padding: 8px 15px;
            border-radius: 6px;
            font-weight: 600;
            font-size: 0.9em;
        }
        
        .response-value.favorite { background: #48bb78; color: white; }
        .response-value.yes { background: #81e6d9; color: #234e52; }
        .response-value.maybe { background: #f6e05e; color: #744210; }
        .response-value.no { background: #fc8181; color: white; }
        .response-value.limit { background: #f56565; color: white; }
        .response-value.none { background: #e2e8f0; color: #718096; }
        
        .summary-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }
        
        .summary-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            border: 2px solid #e2e8f0;
        }
        
        .summary-card h3 {
            font-size: 2.5em;
            margin-bottom: 5px;
        }
        
        .summary-card p {
            color: #718096;
            font-size: 0.9em;
        }
        
        .filter-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .filter-btn {
            padding: 10px 20px;
            border: 2px solid #e2e8f0;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
            font-size: 0.9em;
        }
        
        .filter-btn:hover {
            border-color: #667eea;
        }
        
        .filter-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }
        
        .instruction-box {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 30px;
        }
        
        .instruction-box h3 {
            margin-bottom: 10px;
            font-size: 1.3em;
        }
        
        .instruction-box ol {
            margin-left: 20px;
            line-height: 1.8;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }
            
            .header h1 {
                font-size: 1.8em;
            }
            
            .items-grid {
                grid-template-columns: 1fr;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .option-btn {
                font-size: 0.75em;
                padding: 6px 3px;
            }
            
            .mode-select {
                grid-template-columns: 1fr;
            }
            
            .response-comparison {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="progress-bar">
        <div class="progress-fill" id="progressFill"></div>
    </div>
    
    <div class="container">
        <!-- Mode Selection Screen -->
        <div id="modeScreen">
            <div class="header">
                <h1>üî• Fetish Chart 2025</h1>
                <p>Couples Edition - Compare answers privately</p>
            </div>
            
            <div class="instruction-box">
                <h3>üìã How It Works</h3>
                <ol>
                    <li><strong>Person 1:</strong> Fill out your answers and get a share code</li>
                    <li><strong>Person 2:</strong> Complete the chart independently</li>
                    <li><strong>Enter Partner Code:</strong> Paste Person 1's code when prompted</li>
                    <li><strong>Compare:</strong> See results side-by-side with compatibility scores</li>
                </ol>
                <p style="margin-top: 15px; opacity: 0.9;"><strong>Privacy:</strong> Neither person sees the other's answers until BOTH are complete!</p>
            </div>
            
            <div class="mode-select">
                <div class="mode-card" onclick="startMode('person1')">
                    <h3>üë§ Person 1</h3>
                    <p>I'm filling this out first</p>
                </div>
                <div class="mode-card" onclick="startMode('person2')">
                    <h3>üë• Person 2</h3>
                    <p>My partner sent me their code</p>
                </div>
            </div>
        </div>
        
        <!-- Survey Screen -->
        <div id="surveyScreen" class="hidden">
            <div class="header">
                <h1>üî• Fetish Chart 2025</h1>
                <p id="surveySubtitle">Fill out your preferences</p>
            </div>
            
            <div class="stats" id="stats">
                <div class="stat-item">
                    <h4 id="completedCount">0</h4>
                    <p>Completed</p>
                </div>
                <div class="stat-item">
                    <h4 id="totalCount">0</h4>
                    <p>Total Items</p>
                </div>
                <div class="stat-item">
                    <h4 id="progressPercent">0%</h4>
                    <p>Progress</p>
                </div>
            </div>
            
            <div class="key">
                <h3>üîë Rating Key</h3>
                <div class="key-grid">
                    <div class="key-item">
                        <div class="key-color" style="background: #48bb78;"></div>
                        <span><strong>Favorite:</strong> Love it</span>
                    </div>
                    <div class="key-item">
                        <div class="key-color" style="background: #81e6d9;"></div>
                        <span><strong>Yes:</strong> Enjoyed it</span>
                    </div>
                    <div class="key-item">
                        <div class="key-color" style="background: #f6e05e;"></div>
                        <span><strong>Maybe:</strong> Could try</span>
                    </div>
                    <div class="key-item">
                        <div class="key-color" style="background: #fc8181;"></div>
                        <span><strong>No:</strong> But curious</span>
                    </div>
                    <div class="key-item">
                        <div class="key-color" style="background: #f56565;"></div>
                        <span><strong>Limit:</strong> Never</span>
                    </div>
                </div>
            </div>
            
            <div class="info-section">
                <h3>üìã Your Information</h3>
                <div class="info-grid">
                    <div class="info-field">
                        <label>Name/Nickname</label>
                        <input type="text" id="name" placeholder="Enter name">
                    </div>
                    <div class="info-field">
                        <label>Age</label>
                        <input type="text" id="age" placeholder="Enter age">
                    </div>
                    <div class="info-field">
                        <label>Sexuality</label>
                        <input type="text" id="sexuality" placeholder="Enter sexuality">
                    </div>
                    <div class="info-field">
                        <label>Role</label>
                        <input type="text" id="role" placeholder="Dom/Sub/Switch/etc">
                    </div>
                </div>
            </div>
            
            <div id="sectionsContainer"></div>
            
            <div class="action-buttons">
                <button class="btn btn-primary" id="finishButton" onclick="finishSurvey()">‚úÖ I'm Done - Get Share Code</button>
            </div>
        </div>
        
        <!-- Comparison Screen -->
        <div id="comparisonScreen" class="hidden">
            <div class="header">
                <h1>üíï Compatibility Results</h1>
                <p>See where you match and where you differ</p>
            </div>
            
            <div class="summary-stats" id="summaryStats"></div>
            
            <div class="filter-buttons">
                <button class="filter-btn active" onclick="filterResults('all')">All Items</button>
                <button class="filter-btn" onclick="filterResults('perfect')">Perfect Match</button>
                <button class="filter-btn" onclick="filterResults('close')">Close Match</button>
                <button class="filter-btn" onclick="filterResults('mismatch')">Mismatch</button>
                <button class="filter-btn" onclick="filterResults('unanswered')">Not Answered</button>
            </div>
            
            <div id="comparisonContainer" class="comparison-grid"></div>
            
            <div class="action-buttons">
                <button class="btn btn-secondary" onclick="exportComparison()">üì§ Export Results</button>
                <button class="btn btn-danger" onclick="startOver()">üîÑ Start Over</button>
            </div>
        </div>
    </div>
    
    <!-- Export Modal -->
    <div class="modal" id="exportModal">
        <div class="modal-content">
            <h2 id="modalTitle">üì§ Your Share Code</h2>
            <p id="modalInstructions" style="margin-bottom: 15px; color: #718096;"></p>
            <textarea id="exportText" readonly></textarea>
            <div class="modal-buttons">
                <button class="btn btn-primary" onclick="copyToClipboard()" style="flex: 1;">üìã Copy Code</button>
                <button class="btn btn-tertiary" onclick="closeModal()" style="flex: 1;">Close</button>
            </div>
        </div>
    </div>
    
    <!-- Partner Code Input Modal -->
    <div class="modal" id="partnerCodeModal">
        <div class="modal-content">
            <h2>üîê Enter Partner's Code</h2>
            <p style="margin-bottom: 15px; color: #718096;">Paste the code your partner sent you:</p>
            <textarea id="partnerCodeInput" placeholder="Paste code here..."></textarea>
            <div class="modal-buttons">
                <button class="btn btn-primary" onclick="loadPartnerCode()" style="flex: 1;">‚úÖ Load & Compare</button>
                <button class="btn btn-tertiary" onclick="closeModal()" style="flex: 1;">Cancel</button>
            </div>
        </div>
    </div>
    
    <script>
        const sections = {
            "General": ["Fellatio/Blowjobs", "Swallowing", "Toys", "Cunnilingus", "Deepthroating", "Face Toys", "Handjob", "69ing", "Face Sitting", "Masturbation", "Rimming", "Mutual Masturbation", "Fingering", "Anal Fisting", "Fisting", "Anal Fingering", "Rough Sex", "Spanking/Whipping", "Edging"],
            
            "BDSM": ["Daddy/Little", "Forced Orgasms", "Master/Slave", "Breast/Genital Torture", "Petplay/Pup", "Masturbation Instructions", "Primal", "Edgeplay", "Predator/Prey", "Humiliation Play", "Power Exchange", "Erotic/Sensory Deprivation", "Degradation/Embarrassment", "Public Play", "Name Calling", "Choking", "Soft Bondage", "Flogging", "Rope Bondage", "Wax Play", "Encasement", "Toys", "Immobilization", "Pegging", "Forced Sex/Exhibition", "Whipping", "Rape Play", "Urethral Insertion", "Roleplay", "Sexual Worship", "Gagging", "Body Worship"],
            
            "Pain": ["Physical Pain", "Breast Clamps", "Oral Spanking", "Whipping", "Slapping", "Biting", "Choking", "Hair Pulling", "Cock/Ball Slapping", "Nipple Clamping", "Scratching", "Sadism"],
            
            "Kinks": ["Incest - Cousins", "Incest - Siblings", "Incest - Parent/Child", "Twincest - Children/Any age", "Impregnation/Pregnancy", "Breeding/Creampie", "Feet", "Latex", "Leather", "Choking/Cock/Ball/TIT", "Voyeurism", "Exhibitionism", "Double Penetration", "Multiple Partner", "Furry/Roleplay", "Bestiality", "Monsters", "Tentacles", "Tickling", "Macro/Micro", "Armpit Sex"],
            
            "Clothing": ["Clothed Sex", "Crossdressing", "Denim", "Forced Feminization", "Latex", "Leather", "Lingerie", "Socks", "Stockings", "Suit/Tie/Cosplay"],
            
            "Extreme": ["Scat", "Piss", "Farting", "Vomit", "Necrophilia", "Torture", "Blood Play", "Sexual Mutilation", "Snuffing", "Castration"],
            
            "People - Attraction": ["Non-binary", "Genderfluid", "Skinny", "Chubby/Curvy", "Feminine/Androgynous", "Masculine", "Chubby", "Muscular", "Tall", "Short", "Experienced", "Busty", "Small Penis", "Large Penis", "Shaved", "Large Breasts"],
            
            "People - With You": ["Solo", "Duo", "Masculine", "Goth", "Piercing", "Androgynous", "Tattoos", "Intact Hymen"],
            
            "Other Limits": ["Skinny", "Old", "Hairy", "Ugly", "Facial Hair", "Diapers", "Infants"]
        };
        
        const icons = {
            "General": "üíã",
            "BDSM": "‚õìÔ∏è",
            "Pain": "üí•",
            "Kinks": "üî•",
            "Clothing": "üëó",
            "Extreme": "‚ö†Ô∏è",
            "People - Attraction": "üë•",
            "People - With You": "üíë",
            "Other Limits": "üö´"
        };
        
        const ratingLabels = {
            'favorite': 'Favorite ‚ù§Ô∏è',
            'yes': 'Yes ‚úì',
            'maybe': 'Maybe ?',
            'no': 'No ~',
            'limit': 'Limit ‚úó'
        };
        
        let currentMode = '';
        let responses = {};
        let partnerData = null;
        let currentFilter = 'all';
        
        function startMode(mode) {
            currentMode = mode;
            document.getElementById('modeScreen').classList.add('hidden');
            document.getElementById('surveyScreen').classList.remove('hidden');
            
            if (mode === 'person2') {
                document.getElementById('surveySubtitle').textContent = 'Fill out your preferences (your partner has already completed theirs)';
            }
            
            renderSections();
        }
        
        function renderSections() {
            const container = document.getElementById('sectionsContainer');
            container.innerHTML = '';
            
            Object.keys(sections).forEach(sectionName => {
                const section = document.createElement('div');
                section.className = 'section';
                
                const title = document.createElement('h2');
                title.className = 'section-title';
                title.innerHTML = `<span class="section-icon">${icons[sectionName] || 'üìå'}</span>${sectionName}`;
                section.appendChild(title);
                
                const itemsGrid = document.createElement('div');
                itemsGrid.className = 'items-grid';
                
                sections[sectionName].forEach(itemName => {
                    const item = document.createElement('div');
                    item.className = 'item';
                    
                    const name = document.createElement('div');
                    name.className = 'item-name';
                    name.textContent = itemName;
                    item.appendChild(name);
                    
                    const options = document.createElement('div');
                    options.className = 'item-options';
                    
                    const ratings = [
                        { value: 'favorite', label: '‚ù§Ô∏è', class: 'favorite' },
                        { value: 'yes', label: '‚úì', class: 'yes' },
                        { value: 'maybe', label: '?', class: 'maybe' },
                        { value: 'no', label: '~', class: 'no' },
                        { value: 'limit', label: '‚úó', class: 'limit' }
                    ];
                    
                    ratings.forEach(rating => {
                        const btn = document.createElement('div');
                        btn.className = `option-btn ${rating.class}`;
                        btn.textContent = rating.label;
                        btn.onclick = () => selectOption(sectionName, itemName, rating.value, btn);
                        options.appendChild(btn);
                    });
                    
                    item.appendChild(options);
                    itemsGrid.appendChild(item);
                });
                
                section.appendChild(itemsGrid);
                container.appendChild(section);
            });
            
            updateStats();
        }
        
        function selectOption(section, item, value, btnElement) {
            const key = `${section}|||${item}`;
            
            const siblings = btnElement.parentElement.querySelectorAll('.option-btn');
            siblings.forEach(s => s.classList.remove('selected'));
            
            if (responses[key] === value) {
                delete responses[key];
            } else {
                responses[key] = value;
                btnElement.classList.add('selected');
            }
            
            updateStats();
        }
        
        function updateStats() {
            const totalItems = Object.values(sections).reduce((sum, items) => sum + items.length, 0);
            const completedItems = Object.keys(responses).length;
            const percentage = Math.round((completedItems / totalItems) * 100);
            
            document.getElementById('completedCount').textContent = completedItems;
            document.getElementById('totalCount').textContent = totalItems;
            document.getElementById('progressPercent').textContent = percentage + '%';
            document.getElementById('progressFill').style.width = percentage + '%';
        }
        
        function finishSurvey() {
            const name = document.getElementById('name').value || 'Anonymous';
            const age = document.getElementById('age').value;
            const sexuality = document.getElementById('sexuality').value;
            const role = document.getElementById('role').value;
            
            const completedCount = Object.keys(responses).length;
            const totalItems = Object.values(sections).reduce((sum, items) => sum + items.length, 0);
            
            if (completedCount < totalItems * 0.5) {
                if (!confirm(`You've only completed ${completedCount} out of ${totalItems} items. Continue anyway?`)) {
                    return;
                }
            }
            
            const data = {
                info: { name, age, sexuality, role },
                responses: responses,
                timestamp: new Date().toISOString()
            };
            
            if (currentMode === 'person1') {
                const encoded = btoa(JSON.stringify(data));
                document.getElementById('modalTitle').textContent = 'üì§ Share This Code With Your Partner';
                document.getElementById('modalInstructions').textContent = 'Send this code to your partner. They will enter it after completing their own survey.';
                document.getElementById('exportText').value = encoded;
                document.getElementById('exportModal').classList.add('active');
            } else {
                // Person 2 - prompt for partner code
                localStorage.setItem('person2Data', JSON.stringify(data));
                document.getElementById('partnerCodeModal').classList.add('active');
            }
        }
        
        function loadPartnerCode() {
            const code = document.getElementById('partnerCodeInput').value.trim();
            
            if (!code) {
                alert('Please paste your partner\'s code');
                return;
            }
            
            try {
                const decoded = atob(code);
                partnerData = JSON.parse(decoded);
                
                const person2Data = JSON.parse(localStorage.getItem('person2Data'));
                
                closeModal();
                showComparison(partnerData, person2Data);
            } catch (e) {
                alert('Invalid code. Please check and try again.');
            }
        }
        
        function showComparison(data1, data2) {
            document.getElementById('surveyScreen').classList.add('hidden');
            document.getElementById('comparisonScreen').classList.remove('hidden');
            
            // Calculate stats
            let perfectMatches = 0;
            let closeMatches = 0;
            let mismatches = 0;
            let unanswered = 0;
            
            const allItems = [];
            Object.keys(sections).forEach(sectionName => {
                sections[sectionName].forEach(itemName => {
                    const key = `${sectionName}|||${itemName}`;
                    const r1 = data1.responses[key];
                    const r2 = data2.responses[key];
                    
                    let matchType = 'unanswered';
                    if (r1 && r2) {
                        if (r1 === r2) {
                            matchType = 'perfect';
                            perfectMatches++;
                        } else if (
                            (r1 === 'favorite' && r2 === 'yes') ||
                            (r1 === 'yes' && r2 === 'favorite') ||
                            (r1 === 'yes' && r2 === 'maybe') ||
                            (r1 === 'maybe' && r2 === 'yes')
                        ) {
                            matchType = 'close';
                            closeMatches++;
                        } else {
                            matchType = 'mismatch';
                            mismatches++;
                        }
                    } else {
                        unanswered++;
                    }
                    
                    allItems.push({
                        section: sectionName,
                        item: itemName,
                        response1: r1,
                        response2: r2,
                        matchType: matchType
                    });
                });
            });
            
            // Render summary
            const summaryHTML = `
                <div class="summary-card">
                    <h3 style="color: #48bb78;">${perfectMatches}</h3>
                    <p>Perfect Matches</p>
                </div>
                <div class="summary-card">
                    <h3 style="color: #81e6d9;">${closeMatches}</h3>
                    <p>Close Matches</p>
                </div>
                <div class="summary-card">
                    <h3 style="color: #fc8181;">${mismatches}</h3>
                    <p>Mismatches</p>
                </div>
                <div class="summary-card">
                    <h3 style="color: #718096;">${unanswered}</h3>
                    <p>Not Both Answered</p>
                </div>
            `;
            document.getElementById('summaryStats').innerHTML = summaryHTML;
            
            // Store for filtering
            window.comparisonData = { data1, data2, allItems };
            
            renderComparison(allItems);
        }
        
        function renderComparison(items) {
            const container = document.getElementById('comparisonContainer');
            container.innerHTML = '';
            
            const filtered = currentFilter === 'all' 
                ? items 
                : items.filter(item => item.matchType === currentFilter);
            
            filtered.forEach(item => {
                const div = document.createElement('div');
                div.className = 'comparison-item';
                
                const matchBadge = item.matchType === 'perfect' ? 'Perfect Match ‚ú®' :
                                 item.matchType === 'close' ? 'Close Match üëç' :
                                 item.matchType === 'mismatch' ? 'Mismatch üò¨' :
                                 'Not Answered ‚ùì';
                
                div.innerHTML = `
                    <div class="comparison-header">
                        <h3>${item.item}</h3>
                        <span class="match-badge ${item.matchType}">${matchBadge}</span>
                    </div>
                    <div class="response-comparison">
                        <div class="person-response">
                            <div class="person-label">${window.comparisonData.data1.info.name || 'Person 1'}</div>
                            <span class="response-value ${item.response1 || 'none'}">
                                ${item.response1 ? ratingLabels[item.response1] : 'No Answer'}
                            </span>
                        </div>
                        <div class="person-response">
                            <div class="person-label">${window.comparisonData.data2.info.name || 'Person 2'}</div>
                            <span class="response-value ${item.response2 || 'none'}">
                                ${item.response2 ? ratingLabels[item.response2] : 'No Answer'}
                            </span>
                        </div>
                    </div>
                `;
                
                container.appendChild(div);
            });
            
            if (filtered.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #718096; padding: 40px;">No items in this category</p>';
            }
        }
        
        function filterResults(type) {
            currentFilter = type;
            
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            renderComparison(window.comparisonData.allItems);
        }
        
        function exportComparison() {
            const data = {
                person1: window.comparisonData.data1,
                person2: window.comparisonData.data2,
                timestamp: new Date().toISOString()
            };
            
            const encoded = btoa(JSON.stringify(data));
            document.getElementById('modalTitle').textContent = 'üì§ Export Complete Results';
            document.getElementById('modalInstructions').textContent = 'Save this code to reload your comparison later or share with others.';
            document.getElementById('exportText').value = encoded;
            document.getElementById('exportModal').classList.add('active');
        }
        
        function copyToClipboard() {
            const text = document.getElementById('exportText');
            text.select();
            document.execCommand('copy');
            alert('üìã Copied to clipboard!');
        }
        
        function closeModal() {
            document.getElementById('exportModal').classList.remove('active');
            document.getElementById('partnerCodeModal').classList.remove('active');
        }
        
        function startOver() {
            if (confirm('‚ö†Ô∏è Start over? This will clear everything.')) {
                localStorage.clear();
                location.reload();
            }
        }
    </script>
</body>
</html>
